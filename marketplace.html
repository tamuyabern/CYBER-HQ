<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HQ Marketplace</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
  header { background:#0a8f3d; color:white; padding:1rem; text-align:center; position:sticky; top:0; z-index:10; }
  header h1 { margin:0; display:inline-block; }
  .actions { display:flex; justify-content:center; gap:0.6rem; margin:10px 0; flex-wrap:wrap; align-items:center; }
  .action-btn { background:orange; color:black; border:none; padding:6px 12px; border-radius:20px; cursor:pointer; font-weight:bold; }
  .action-btn:hover { background:darkorange; }
  .sign-btn { background:#1da1f2; color:white; }
  .small-btn { padding:6px 8px; border-radius:12px; font-size:13px; }

  .categories { display:flex; overflow-x:auto; gap:8px; padding:10px; background:#eaf7ed; }
  .category { flex:0 0 auto; background:white; border:1px solid #0a8f3d; border-radius:20px; padding:6px 14px; cursor:pointer; }
  .category.active { background:#0a8f3d; color:white; }

  /* Search Box */
  .search-container {
    padding: 10px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: center;
  }
  .search-container input {
    width: 90%;
    max-width: 500px;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 15px;
  }

  /* Price & Sort bar */
  .controls {
    display:flex; gap:8px; align-items:center; justify-content:center;
    padding:10px; background:#fff; border-bottom:1px solid #eee; flex-wrap:wrap;
  }
  .controls input[type="number"] { width:120px; padding:6px; border-radius:8px; }
  .controls select { padding:6px; border-radius:8px; }

  /* Grid Layout */
  .container {
    padding:1rem;
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap:1rem;
  }
  @media (max-width:480px) { .container { grid-template-columns: repeat(2, 1fr); } }
  @media (min-width:481px) and (max-width:768px) { .container { grid-template-columns: repeat(3, 1fr); } }
  @media (min-width:769px) { .container { grid-template-columns: repeat(4, 1fr); } }

  .card { background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; text-align:center; position:relative; }
  .card img { width:100%; height:160px; object-fit:cover; }
  .card-body { padding:0.5rem; }
  .card-body h3 { margin:4px 0; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:6px; }
  .phone { background:orange; color:black; padding:5px 8px; border-radius:6px; text-decoration:none; font-weight:bold; display:inline-block; }

  /* Favorite star */
  .fav { position:absolute; top:8px; right:8px; background:rgba(255,255,255,0.95); border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.12); font-size:18px; }
  .fav.active { color:gold; }

  /* Floating Add Button */
  .fab {
    position:fixed; bottom:20px; right:20px;
    background:#0a8f3d; color:white; border:none;
    border-radius:50%; width:55px; height:55px;
    font-size:28px; cursor:pointer;
    box-shadow:0 4px 8px rgba(0,0,0,0.3);
    display:flex; align-items:center; justify-content:center;
    z-index:1100;
  }
  .fab:hover { transform:scale(1.1); background:#0c6f2f; }

  /* Modal */
  .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
  .modal-content { background:white; padding:1rem; border-radius:10px; width:95%; max-width:520px; max-height:90vh; overflow-y:auto; position:relative; }
  .modal-content h2 { margin-top:0; color:#0a8f3d; }
  .close { position:absolute; top:8px; right:12px; cursor:pointer; font-size:1.4rem; color:red; }

  input, select, textarea { width:100%; margin-bottom:8px; padding:6px; border:1px solid #ccc; border-radius:6px; }
  .submit-btn { background:#0a8f3d; color:white; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; }

  /* Image previews */
  #imagePreviewContainer { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  #imagePreviewContainer img { width:80px; height:80px; object-fit:cover; border-radius:6px; border:1px solid #ccc; }

  /* Verified Badge */
  .verified { color:#1da1f2; font-size:16px; }
  .user-info { display:flex; align-items:center; gap:6px; }

  /* Carousel in detail modal */
  .carousel { display:flex; overflow-x:auto; gap:8px; }
  .carousel img { width:100%; max-height:250px; object-fit:cover; border-radius:8px; flex:0 0 100%; }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;justify-content:center;gap:12px;">
    <h1>HQ Marketplace</h1>
    <div class="actions" style="margin:0;">
      <button class="action-btn small-btn" onclick="window.location.href='index.html'">â¬… Home</button>
      <button class="action-btn small-btn" id="savedBtn" onclick="showSaved()">Saved</button>
      <button class="action-btn sign-btn small-btn" id="signBtn" onclick="googleSign()">Sign In</button>
      <span id="userEmail" class="user-info" style="display:none;"></span>
    </div>
  </div>
</header>

<!-- Search Section -->
<div class="search-container">
  <input type="text" id="searchInput" placeholder="Search products..." onkeyup="searchProducts()">
</div>

<!-- Controls: category above, then price+sort -->
<div class="categories" id="categories">
  <div class="category active" onclick="filterCategory('all', this)">All</div>
  <div class="category" onclick="filterCategory('Phones', this)">Phones</div>
  <div class="category" onclick="filterCategory('Cars', this)">Cars</div>
  <div class="category" onclick="filterCategory('Kitchen', this)">Kitchen</div>
  <div class="category" onclick="filterCategory('Electronics', this)">Electronics</div>
  <div class="category" onclick="filterCategory('Furniture', this)">Furniture</div>
</div>

<div class="controls">
  <label>Min Ksh: <input type="number" id="minPrice" placeholder="0"></label>
  <label>Max Ksh: <input type="number" id="maxPrice" placeholder="Any"></label>
  <button class="action-btn small-btn" onclick="applyPriceFilter()">Apply Price</button>
  <button class="action-btn small-btn" onclick="resetPriceFilter()">Reset Price</button>

  <label>
    Sort:
    <select id="sortSelect" onchange="sortProducts()">
      <option value="newest">Newest First</option>
      <option value="low">Price: Low â†’ High</option>
      <option value="high">Price: High â†’ Low</option>
    </select>
  </label>
</div>

<div class="container" id="products"></div>

<!-- Floating Add Button -->
<button class="fab" onclick="openForm()">+</button>

<!-- Product Detail Modal -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <span class="close" onclick="closeDetail()">Ã—</span>
    <div id="detailBody"></div>
  </div>
</div>

<!-- Post Product Modal -->
<div class="modal" id="formModal">
  <div class="modal-content">
    <span class="close" onclick="closeForm()">Ã—</span>
    <h2>Post Your Product</h2>
    <input type="text" id="name" placeholder="Product Name" required />
    <input type="number" id="price" placeholder="Price (KES)" required />
    <input type="text" id="phone" placeholder="Phone Number" required />
    <select id="category">
      <option value="Phones">Phones</option>
      <option value="Cars">Cars</option>
      <option value="Kitchen">Kitchen</option>
      <option value="Electronics">Electronics</option>
      <option value="Furniture">Furniture</option>
    </select>
    <textarea id="description" placeholder="Description"></textarea>
    <input type="text" id="condition" placeholder="Condition (New/Used)" />
    <input type="text" id="specs" placeholder="Specifications" />
    <input type="text" id="region" placeholder="Location/Region" />
    <input type="file" id="imageFile" accept="image/*" multiple />
    <div id="imagePreviewContainer"></div>
    <button class="submit-btn" onclick="saveProduct()">Save Product</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYhi7mvWs1JZq4Zof3w3eI0d1CXhZRTp4",
  authDomain: "hq-marketplace-ec236.firebaseapp.com",
  projectId: "hq-marketplace-ec236",
  storageBucket: "hq-marketplace-ec236.appspot.com",
  messagingSenderId: "861547577050",
  appId: "1:861547577050:web:507b1411e3e199eae3afe3"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let uploadedImages = [];
let productsArr = []; // local copy of products (id + data)
let userFavorites = []; // array of productIds favorited by current user
let showingSavedOnly = false;

// Auth state listener
onAuthStateChanged(auth, async user => {
  currentUser = user;
  const signBtn = document.getElementById("signBtn");
  const userEmail = document.getElementById("userEmail");
  if(user){
    signBtn.textContent="Sign Out";
    userEmail.innerHTML = `${user.displayName || user.email} <span class="verified">âœ”</span>`;
    userEmail.style.display="inline";
    await loadUserFavorites();
    // If user just signed in and "saved view" was active, re-apply
  }else{
    signBtn.textContent="Sign In";
    userEmail.style.display="none";
    userFavorites = [];
  }
  // update star state if products already rendered
  updateFavoriteIcons();
});

// Google Sign In/Out
window.googleSign = async () => {
  if(currentUser){ await signOut(auth); return; }
  try{ await signInWithPopup(auth, provider); }
  catch(err){ alert("Google sign-in failed: "+err.message); }
};

// Require login before posting
window.openForm = () => {
  if (!currentUser) { alert("You must sign in first to post items."); return; }
  document.getElementById("formModal").style.display="flex";
};
window.closeForm = () => document.getElementById("formModal").style.display="none";

// Product Detail Modal
window.showDetail = (el) => {
  const p = JSON.parse(el.dataset.product);
  let imagesHtml = "";
  if (p.images && p.images.length){
    imagesHtml = `<div class="carousel">${p.images.map(url=>`<img src="${url}">`).join("")}</div>`;
  } else {
    imagesHtml = `<img src="${p.image}" style="width:100%; max-height:250px; object-fit:cover; border-radius:8px;">`;
  }

  // phone display: if not signed in show CTA, else show number
  const phoneHtml = currentUser
    ? `<a class="phone" href="tel:${p.phone}">ðŸ“ž ${p.phone}</a>`
    : `<button class="phone" onclick="requestPhoneAccess('${p.phone}')">Show phone number</button>`;

  document.getElementById("detailBody").innerHTML = `
    <h2>${p.name} ${p.verified ? '<span class="verified">âœ”</span>' : ''}</h2>
    ${imagesHtml}
    <p><b>Price:</b> <span style="color:green; font-weight:bold;">Ksh ${p.price}</span></p>
    <p><b>Description:</b> ${p.description}</p>
    <p><b>Condition:</b> ${p.condition}</p>
    <p><b>Category:</b> ${p.category}</p>
    <p><b>Specifications:</b> ${p.specs}</p>
    <p><b>Location:</b> ${p.region}</p>
    <p>${phoneHtml}</p>
  `;
  document.getElementById("detailModal").style.display = "flex";
};
window.closeDetail = () => document.getElementById("detailModal").style.display = "none";

// Phone access CTA
window.requestPhoneAccess = async (phone) => {
  if (!currentUser) {
    const ok = confirm("Please sign in to view phone numbers. Sign in now?");
    if(ok) await signInWithPopup(auth, provider);
    return;
  }
  alert("Phone number: " + phone);
};

// Category filter (independent of search/price)
window.filterCategory = (cat, el) => {
  document.querySelectorAll(".category").forEach(c=>c.classList.remove("active"));
  el.classList.add("active");
  document.querySelectorAll(".card").forEach(card=>{
    card.style.display = (cat==='all' || card.dataset.category===cat) ? 'block' : 'none';
  });
};

// Search products (independent)
window.searchProducts = () => {
  const query = document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll(".card").forEach(card => {
    const p = JSON.parse(card.dataset.product);
    const text = `${p.name} ${p.description} ${p.category} ${p.region}`.toLowerCase();
    card.style.display = text.includes(query) ? "block" : "none";
  });
};

// Price filter (independent)
window.applyPriceFilter = () => {
  const min = Number(document.getElementById("minPrice").value || 0);
  const maxRaw = document.getElementById("maxPrice").value;
  const max = maxRaw === "" ? Infinity : Number(maxRaw);
  document.querySelectorAll(".card").forEach(card => {
    const p = JSON.parse(card.dataset.product);
    const price = Number(p.price) || 0;
    card.style.display = (price >= min && price <= max) ? "block" : "none";
  });
};
window.resetPriceFilter = () => {
  document.getElementById("minPrice").value = "";
  document.getElementById("maxPrice").value = "";
  document.querySelectorAll(".card").forEach(card => card.style.display = "block");
};

// Sort (reorders DOM, independent)
window.sortProducts = () => {
  const mode = document.getElementById("sortSelect").value;
  // read current DOM cards into array with their product data
  const container = document.getElementById("products");
  const cards = Array.from(container.querySelectorAll(".card"));
  cards.sort((a,b)=>{
    const pa = JSON.parse(a.dataset.product);
    const pb = JSON.parse(b.dataset.product);
    if(mode === "newest"){
      // compare createdAt (ISO strings)
      const da = pa.createdAt || "";
      const db = pb.createdAt || "";
      return (db.localeCompare(da)); // newest first
    } else if(mode === "low"){
      return (Number(pa.price) || 0) - (Number(pb.price) || 0);
    } else {
      return (Number(pb.price) || 0) - (Number(pa.price) || 0);
    }
  });
  // re-append in new order
  cards.forEach(c => container.appendChild(c));
};

// Saved / favorites view
window.showSaved = async () => {
  if (!currentUser) {
    alert("Sign in to view saved items.");
    return;
  }
  // toggle behavior: if already showing saved, reset
  showingSavedOnly = !showingSavedOnly;
  document.getElementById("savedBtn").textContent = showingSavedOnly ? "All Products" : "Saved";
  if (showingSavedOnly) {
    document.querySelectorAll(".card").forEach(card=>{
      card.style.display = userFavorites.includes(card.dataset.id) ? 'block' : 'none';
    });
  } else {
    document.querySelectorAll(".card").forEach(card=>card.style.display='block');
  }
};

// Favorite toggle
window.toggleFavorite = async (productId) => {
  if (!currentUser) {
    const ok = confirm("Sign in to save favorites. Sign in now?");
    if(ok) await signInWithPopup(auth, provider);
    return;
  }
  const favDoc = doc(db, "favorites", currentUser.uid);
  const has = userFavorites.includes(productId);
  try{
    if(has){
      await updateDoc(favDoc, { productIds: arrayRemove(productId) });
    } else {
      // ensure doc exists then update
      const d = await getDoc(favDoc);
      if(!d.exists()){
        await setDoc(favDoc, { productIds: [productId] });
      } else {
        await updateDoc(favDoc, { productIds: arrayUnion(productId) });
      }
    }
    await loadUserFavorites(); // refresh local favorites & icons
  }catch(err){
    console.error(err); alert("Could not update favorites: "+err.message);
  }
};

// Load user favorites into userFavorites array and update UI
async function loadUserFavorites(){
  if(!currentUser) { userFavorites = []; updateFavoriteIcons(); return; }
  try{
    const favDocRef = doc(db, "favorites", currentUser.uid);
    const favSnap = await getDoc(favDocRef);
    userFavorites = favSnap.exists() && Array.isArray(favSnap.data().productIds) ? favSnap.data().productIds : [];
    updateFavoriteIcons();
  }catch(err){
    console.error(err);
  }
}

// Update star icon states based on userFavorites
function updateFavoriteIcons(){
  document.querySelectorAll(".card").forEach(card=>{
    const star = card.querySelector(".fav");
    if(!star) return;
    const id = card.dataset.id;
    if(userFavorites.includes(id)){
      star.classList.add("active");
      star.innerHTML = "â˜…";
    } else {
      star.classList.remove("active");
      star.innerHTML = "â˜†";
    }
  });
}

/* ----------------------------
   Image preview + upload multiple
   ---------------------------- */
document.getElementById("imageFile").addEventListener("change", async (e)=>{
  const files = e.target.files;
  uploadedImages = [];
  const previewContainer = document.getElementById("imagePreviewContainer");
  previewContainer.innerHTML = "";

  for (const file of files){
    const imgEl = document.createElement("img");
    imgEl.src = URL.createObjectURL(file);
    previewContainer.appendChild(imgEl);

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "hq cyber");
    const cloudName = "dqxppopjr";
    try{
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method:"POST", body:formData
      });
      const data = await res.json();
      if(data.secure_url) uploadedImages.push(data.secure_url);
    }catch(err){ console.error(err); alert("Upload failed."); }
  }
});

/* ----------------------------
   Save product
   ---------------------------- */
window.saveProduct = async () => {
  if (!currentUser) { alert("Sign in first"); return; }
  if (uploadedImages.length === 0) { alert("Please upload images"); return; }

  const priceVal = Number(document.getElementById("price").value || 0);

  const product = {
    name: document.getElementById("name").value,
    price: priceVal,
    phone: document.getElementById("phone").value,
    category: document.getElementById("category").value,
    description: document.getElementById("description").value,
    condition: document.getElementById("condition").value,
    specs: document.getElementById("specs").value,
    region: document.getElementById("region").value,
    images: uploadedImages,
    verified: true,
    createdAt: (new Date()).toISOString(),
    ownerUid: currentUser.uid,
    ownerName: currentUser.displayName || currentUser.email
  };

  try{
    await addDoc(collection(db,"products"), product);
    alert("Product posted!");
    closeForm();
    document.getElementById("imageFile").value="";
    document.getElementById("imagePreviewContainer").innerHTML="";
    uploadedImages = [];
  }catch(err){ console.error(err); alert("Save failed."); }
};

/* ----------------------------
   Real-time fetch & render
   ---------------------------- */
onSnapshot(collection(db,"products"), snapshot=>{
  productsArr = [];
  snapshot.forEach(docSnap=>{
    const p = docSnap.data();
    productsArr.push({ id: docSnap.id, data: p });
  });
  renderProducts();
});

// Render all products into DOM (initial render / refresh)
function renderProducts(){
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML = "";
  productsArr.forEach(item => {
    const p = item.data;
    const id = item.id;
    const div = document.createElement("div");
    div.className="card";
    div.dataset.category = p.category || "";
    div.dataset.product = JSON.stringify(p);
    div.dataset.id = id;
    const imgSrc = p.images && p.images.length ? p.images[0] : (p.image || "");
    // Favorite star (clickable)
    const starBtn = document.createElement("div");
    starBtn.className = "fav";
    starBtn.title = "Save to favorites";
    starBtn.onclick = (ev) => { ev.stopPropagation(); toggleFavorite(id); };
    starBtn.innerHTML = userFavorites.includes(id) ? "â˜…" : "â˜†";
    if(userFavorites.includes(id)) starBtn.classList.add("active");
    div.appendChild(starBtn);

    div.innerHTML += `
      <img src="${imgSrc}" alt="${p.name}">
      <div class="card-body">
        <h3>${p.name} ${p.verified ? '<span class="verified">âœ”</span>' : ''}</h3>
        <p style="margin:6px 0;"><b>Ksh ${p.price}</b></p>
        ${ currentUser ? `<a class="phone" href="tel:${p.phone}">ðŸ“ž ${p.phone}</a>`
                        : `<button class="phone" onclick="requestPhoneAccess('${p.phone}')">Show phone number</button>`
        }
      </div>
    `;
    div.onclick = ()=>showDetail(div);
    productsDiv.appendChild(div);
  });

  // After adding cards, ensure favorite icons match any updated userFavorites
  updateFavoriteIcons();

  // If sort option is not default, reapply ordering
  sortProducts();
}
</script>
</body>
</html>
