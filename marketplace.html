<!-- Replace the image input in your Post Product Modal -->
<input type="file" id="imageUpload" accept="image/*" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCYhi7mvWs1JZq4Zof3w3eI0d1CXhZRTp4",
    authDomain: "hq-marketplace-ec236.firebaseapp.com",
    projectId: "hq-marketplace-ec236",
    storageBucket: "hq-marketplace-ec236.appspot.com",
    messagingSenderId: "861547577050",
    appId: "1:861547577050:web:507b1411e3e199eae3afe3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const productsDiv = document.getElementById("products");
  const detailModal = document.getElementById("detailModal");
  const detailContent = document.getElementById("detailContent");

  // Convert file to Base64
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  async function saveProduct() {
    const file = document.getElementById("imageUpload").files[0];
    let imageBase64 = "";

    if (file) {
      imageBase64 = await toBase64(file);
    }

    const product = {
      name: document.getElementById("name").value,
      price: document.getElementById("price").value,
      phone: document.getElementById("phone").value,
      category: document.getElementById("category").value,
      description: document.getElementById("description").value,
      condition: document.getElementById("condition").value,
      specs: document.getElementById("specs").value,
      region: document.getElementById("region").value,
      image: imageBase64 || "https://via.placeholder.com/150"
    };

    await addDoc(collection(db, "products"), product);
    closeForm();
  }
  window.saveProduct = saveProduct;

  // Show product details
  function showDetail(el) {
    const p = JSON.parse(el.dataset.product);
    detailContent.innerHTML = `
      <span class="close" onclick="closeDetail()">Ã—</span>
      <h2>${p.name}</h2>
      <img src="${p.image}" alt="${p.name}" style="width:100%; max-height:250px; object-fit:cover; border-radius:8px;">
      <p><b>Price:</b> <span style="color:green; font-weight:bold;">Ksh ${p.price}</span></p>
      <p><b>Description:</b> ${p.description}</p>
      <p><b>Condition:</b> ${p.condition}</p>
      <p><b>Category:</b> ${p.category}</p>
      <p><b>Specifications:</b> ${p.specs}</p>
      <p><b>Location:</b> ${p.region}</p>
      <p><a href="tel:${p.phone}" class="phone">ðŸ“ž ${p.phone}</a></p>
    `;
    detailModal.style.display = "flex";
  }
  window.showDetail = showDetail;
  window.closeDetail = () => detailModal.style.display = "none";

  // Real-time fetch
  onSnapshot(collection(db, "products"), (snapshot) => {
    productsDiv.innerHTML = "";
    snapshot.forEach((doc) => {
      const p = doc.data();
      const div = document.createElement("div");
      div.className = "card";
      div.dataset.category = p.category;
      div.dataset.product = JSON.stringify(p);
      div.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <div class="card-body">
          <h3>${p.name}</h3>
          <a class="phone" href="tel:${p.phone}">ðŸ“ž ${p.phone}</a>
        </div>
      `;
      div.onclick = () => showDetail(div);
      productsDiv.appendChild(div);
    });
  });
</script>
